' http://msdn.microsoft.com/en-us/library/windows/desktop/aa705902(v=vs.85).aspx
' Create AD LDS Organizational Unit.

Option Explicit

Dim objDOMAD         ' Binding object.
Dim objOU           ' Organizational unit.
Dim strDescription  ' Description of OU.
Dim strOU           ' Organizational unit.
Dim strPath         ' Binding path.
Dim iItem
Dim iTemSubOU
Dim strOUBase
DIm objOUPai

' String de pesquisa.

' ==============	OU=DOMAD
' Criando a OU Base:

WScript.Echo "Certifique-se que as OU configuradas neste script não existam, caso contrario este script falhará"

' Bind to object.
strPath = "LDAP://dc=domad,dc=mtulio,dc=eng,dc=br"
Set objOUPai = GetObject(strPath)

'strPath = "LDAP://localhost:389/dc=domad,dc=mtulio,dc=eng,dc=br"
'WScript.Echo "Pesquisando na base: " & strPath


Dim DNPai 
DNPai = "dc=DOMAD,dc=mtulio,dc=eng,dc=br"
Set objOUPai = GetObject("LDAP://" & DNPai)

strOU = "ou=DOMAD"
strDescription = "MTulio ENG - Dominio AD (DOMAD)"

'WScript.Echo "Criando:  " & strOU

' Criando a estrutura da Unidade
Set objOU = objOUPai.Create("organizationalUnit", strOU)
objOU.Put "description", strDescription
objOU.SetInfo

' Saida: Sucesso ou Erro.
If Err.Number <> vbEmpty Then
	WScript.Echo "Erro:   Falha na criação.\n" & Err.Number
'Else
	'WScript.Echo "Sucesso: Organizational Unit criada com sucesso."
End If


' ==============	OU=UNIDADES,OU=DOMAD
' Quatro Unidades Organizacionais para 5 Filiais
' Matriz 2 X 5
Dim vetorOU(2,4)

vetorOU(0,0) = Array("ou=GYN", "Unidade Goiania-GO")
vetorOU(1,0) = Array("ou=USUARIOS","ou=GRUPOS","ou=COMPUTADORES","ou=OBJETOS" )
vetorOU(2,0) = Array("cn=gynuser")

vetorOU(0,1) = Array("ou=ANA", "Unidade Anapolis-GO")
vetorOU(1,1) = Array("ou=USUARIOS","ou=GRUPOS","ou=COMPUTADORES","ou=OBJETOS" )
vetorOU(2,0) = Array("cn=gynuser")

vetorOU(0,2) = Array("ou=URU", "Unidade Uruacu-GO")
vetorOU(1,2) = Array("ou=USUARIOS","ou=GRUPOS","ou=COMPUTADORES","ou=OBJETOS" )
vetorOU(2,0) = Array("cn=gynuser")

vetorOU(0,3) = Array("ou=FOR", "Unidade Fortaleza-CE")
vetorOU(1,3) = Array("ou=USUARIOS","ou=GRUPOS","ou=COMPUTADORES","ou=OBJETOS" )
vetorOU(2,0) = Array("cn=gynuser")

vetorOU(0,4) = Array("ou=SPO", "Unidade Sao Paulo-SP")
vetorOU(1,4) = Array("ou=USUARIOS","ou=GRUPOS","ou=COMPUTADORES","ou=OBJETOS" )
vetorOU(2,0) = Array("cn=gynuser")

' ======== 	Criando as unidades: ou=Unidade,ou=DOMAD
strPath = "LDAP://ou=DOMAD,dc=DOMAD,dc=mtulio,dc=eng,dc=br"

Dim DNAtual, DNFilho


	For iItem=0 To UBound(vetorOU,2) 
		DNPai = "ou=DOMAD,dc=DOMAD,dc=mtulio,dc=eng,dc=br"
		DNAtual = vetorOU(0,iItem)(0)
		
		Set objOUPai = GetObject("LDAP://" & DNPai)
		
		' Buscando a Unidade Organizacional no Vetor
		strOU = DNAtual
		strDescription = vetorOU(0,iItem)(1)
		
		strOUBase = strOU
		
		'WScript.Echo "Criando:  " & strOU & "," & DNPai
		
		' Criando a estrutura da Unidade
		Set objOU = objOUPai.Create("organizationalUnit", strOU)
		objOU.Put "description", strDescription
		objOU.SetInfo
		
		' Saida: Sucesso ou Erro.
		If Err.Number <> vbEmpty Then
			WScript.Echo "Erro:   Falha na criação."
		'Else
			'WScript.Echo "Sucesso: Organizational Unit criada com sucesso."
		End If
		
		DNPai = DNAtual & "," & DNPai
		' Criando a estrutura Basica
		For iTemSubOU=0 To UBound(vetorOU(1,iItem))
			DNFilho = lcase(vetorOU(1,iItem)(iTemSubOU))
			'WScript.Echo "DN PAI:  " & DNPai
			WScript.Echo "DN FILHO:  " & DNFilho
			Set objOUPai = GetObject("LDAP://" & DNPai)
	
			strOU = lcase(vetorOU(1,iItem)(iTemSubOU))
			'trDescription = strOUBase & " - " & strOU
			
			'WScript.Echo "Criando:  " & strOU
			' Criando a estrutura da Unidade
			Set objOU = objOUPai.Create("organizationalUnit", strOU)
			'objOU.Put "description", strDescription
			objOU.SetInfo
		
			' Saida: Sucesso ou Erro.
			If Err.Number <> vbEmpty Then
				WScript.Echo "Erro:   Falha na criação."
			'Else
				'WScript.Echo "Sucesso: Organizational Unit criada com sucesso."
			End If
			
			' Populando
			' http://gallery.technet.microsoft.com/scriptcenter/a332ca29-0610-4be4-88f0-63771d04743f
			' http://www.macoratti.net/file_vb.htm
			
			If strOU = "ou=usuarios" Then
				WScript.Echo "Criando Usuarios."
				Dim i, userNamePrefix, username
				Dim objUser
				For i = 1 To 99 
					userNamePrefix = lcase(vetorOU(2,iItem)(iTemSubOU))
					username = userNamePrefix & i
					WScript.Echo "Username: " & username
					Set objUser = objOUPai.Create("User", userName) 
					objUser.Put "sAMAccountName", userName 
					objUser.SetInfo 
				Next 
			End if
			
			
		Next
	Next
	
	WScript.Echo "Script executado com sucesso."